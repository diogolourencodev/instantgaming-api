<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SearchGames LATAM</title>
    <style>
      :root { color-scheme: light dark; --primary-color: #667eea; --primary-dark: #5a6fd8; --secondary-color: #764ba2; --text-color: #333; --text-light: #666; --background: #fff; --card-bg: #f8f9fa; --border-color: #e1e5e9; --shadow: 0 4px 6px rgba(0,0,0,0.1); --shadow-hover: 0 8px 15px rgba(0,0,0,0.15); --success-color: #10b981; --free-color: #22c55e; }
      @media (prefers-color-scheme: dark) { :root { --text-color:#f0f0f0; --text-light:#a0a0a0; --background:#1a1a1a; --card-bg:#2d2d2d; --border-color:#404040; --shadow:0 4px 6px rgba(0,0,0,0.3); --shadow-hover:0 8px 15px rgba(0,0,0,0.4);} }
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--background);color:var(--text-color);} 
      main{max-width:1200px;margin:0 auto;padding:2rem 1rem;} 
      .banner{text-align:center;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:white;padding:3rem 2rem;border-radius:16px;margin-bottom:2rem;box-shadow:var(--shadow);} 
      .banner h1{font-size:3rem;margin:0 0 1rem 0;font-weight:700;} 
      .banner-subtitle{font-size:1.2rem;margin:0;opacity:0.9;font-weight:300;} 
      .search-container{margin-bottom:2rem;} 
      .search-box{display:flex;gap:12px;max-width:600px;margin:0 auto;} 
      #query-search{flex:1;padding:1rem 1.5rem;border:2px solid var(--border-color);border-radius:50px;font-size:1.1rem;background:var(--card-bg);color:var(--text-color);transition:all 0.3s ease;} 
      #query-search:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(102,126,234,0.1);} 
      #search-btn{padding:1rem 2rem;background:var(--primary-color);color:white;border:none;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;} 
      #search-btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:var(--shadow-hover);} 
      .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:1.5rem;margin-top:2rem;} 
      .game-card{background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);transition:all 0.3s ease;border:1px solid var(--border-color);} 
      .game-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-hover);} 
      .game-link{text-decoration:none;color:inherit;display:block;height:100%;} 
      .game-card-content{padding:1.5rem;position:relative;height:100%;display:flex;flex-direction:column;justify-content:space-between;} 
      .game-info{flex:1;} 
      .game-title{font-size:1.2rem;font-weight:600;margin:0 0 1rem 0;line-height:1.4;color:var(--text-color);} 
      .game-details{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;} 
      .game-price{font-size:1.4rem;font-weight:700;color:var(--primary-color);} 
      .game-price.free{color:var(--free-color);} 
      .game-origin{background:var(--primary-color);color:white;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.85rem;font-weight:500;} 
      .loading{text-align:center;padding:3rem;} 
      .spinner{border:4px solid var(--border-color);border-left:4px solid var(--primary-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 1rem;} 
      @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}} 
      .hidden{display:none;} 
      .no-results,.error-message{text-align:center;padding:3rem;grid-column:1 / -1;background:var(--card-bg);border-radius:12px;border:2px dashed var(--border-color);} 
      @media (max-width:768px){main{padding:1rem;}.banner{padding:2rem 1rem;}.banner h1{font-size:2rem;}.banner-subtitle{font-size:1rem;}.search-box{flex-direction:column;}.games-grid{grid-template-columns:1fr;gap:1rem;}.game-details{flex-direction:column;align-items:flex-start;}} 
      .site-footer{max-width:1200px;margin:2rem auto 0 auto;padding:1rem;text-align:center;color:var(--text-light);} 
      .site-footer a{color:inherit;text-decoration:underline;} 
      .eneba-manual-card{border:2px dashed #667eea;background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));} 
      .eneba-manual-card:hover{border-color:#667eea;transform:translateY(-2px);} 
      .eneba-warning{font-size:0.9rem;color:var(--text-light);margin:0.5rem 0 0 0;line-height:1.4;} 
      .manual-search-badge{position:absolute;top:-10px;right:-10px;background:#f59e0b;color:white;padding:0.5rem 1rem;border-radius:20px;font-size:0.8rem;font-weight:600;box-shadow:var(--shadow);} 
      .lang-toggle{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;} 
      .lang-btn{background:var(--card-bg);border:1px solid var(--border-color);color:var(--text-color);padding:0.5rem 0.75rem;border-radius:20px;text-decoration:none;font-size:0.9rem;} 
      .lang-btn.active{background:var(--primary-color);color:white;border-color:var(--primary-color);} 
    </style>
  </head>
  <body>
    <main>
      <div class="banner">
        <div class="lang-toggle">
          <a id="lang-pt" href="?lang=pt" class="lang-btn">PT-BR</a>
          <a id="lang-en" href="?lang=en" class="lang-btn">EN</a>
        </div>
        <h1 id="title">SearchGames LATAM</h1>
        <p id="subtitle" class="banner-subtitle">Encontre os melhores pre√ßos de jogos em todas as lojas</p>
        <p id="obs">OBS: Se o jogo n√£o aparecer, √© porque ele n√£o est√° em estoque no momento ou houve um problema na pesquisa.</p>
      </div>

      <div class="search-container">
        <div class="search-box">
          <input type="text" name="query" required id="query-search" placeholder="Digite o nome do jogo...">
          <button id="search-btn" type="button">üîç Buscar</button>
        </div>
      </div>

      <div class="games-grid" id="div-result-games"></div>

      <div id="loading-message" class="loading hidden">
        <div class="spinner"></div>
        <p id="loading-text">Procurando os melhores pre√ßos...</p>
      </div>
    </main>

    <footer class="site-footer">
      <p id="credits">Feito por <a href="https://github.com/diogolourencodev" target="_blank" rel="noopener">github.com/diogolourencodev</a></p>
    </footer>

    <script>
      // Strings PT/EN
      const STRINGS = {
        en: {
          subtitle: 'Find the best game prices across stores',
          obs: 'Note: If the game does not appear, it may be out of stock or there was an issue during the search.',
          input_placeholder: 'Type the game name...',
          search_button: 'üîç Search',
          loading_text: 'Searching for the best prices...',
          no_results_title: 'No games found for',
          no_results_tip: 'Try different terms or check the spelling.',
          error_unexpected: 'An unexpected error occurred. Please try again.',
          eneba_manual_title: 'üîç Manual Search on Eneba',
          eneba_manual_cta: 'Click to search manually',
          eneba_manual_warn: 'We could not automatically retrieve Eneba data. Click here to perform a manual search on the official site.',
          eneba_manual_badge: '‚ö†Ô∏è Manual Search',
          credits_by: 'Built by',
          lang_pt: 'PT-BR', lang_en: 'EN'
        },
        pt: {
          subtitle: 'Encontre os melhores pre√ßos de jogos em todas as lojas',
          obs: 'OBS: Se o jogo n√£o aparecer, √© porque ele n√£o est√° em estoque no momento ou houve um problema na pesquisa.',
          input_placeholder: 'Digite o nome do jogo...',
          search_button: 'üîç Buscar',
          loading_text: 'Procurando os melhores pre√ßos...',
          no_results_title: 'Nenhum jogo encontrado para',
          no_results_tip: 'Tente usar termos diferentes ou verificar a ortografia.',
          error_unexpected: 'Ocorreu um erro inesperado. Tente novamente.',
          eneba_manual_title: 'üîç Pesquisa Manual na Eneba',
          eneba_manual_cta: 'Clique para pesquisar manualmente',
          eneba_manual_warn: 'N√£o foi poss√≠vel obter os dados da Eneba automaticamente. Clique aqui para fazer uma pesquisa manual no site oficial.',
          eneba_manual_badge: '‚ö†Ô∏è Pesquisa Manual',
          credits_by: 'Feito por',
          lang_pt: 'PT-BR', lang_en: 'EN'
        }
      };

      const lang = (new URLSearchParams(location.search).get('lang') || 'pt').toLowerCase();
      const T = STRINGS[lang] || STRINGS.pt;
      document.getElementById('subtitle').textContent = T.subtitle;
      document.getElementById('obs').textContent = T.obs;
      document.getElementById('query-search').placeholder = T.input_placeholder;
      document.getElementById('search-btn').textContent = T.search_button;
      document.getElementById('loading-text').textContent = T.loading_text;
      document.getElementById('credits').innerHTML = `${T.credits_by} <a href="https://github.com/diogolourencodev" target="_blank" rel="noopener">github.com/diogolourencodev</a>`;
      const langPt = document.getElementById('lang-pt'); const langEn = document.getElementById('lang-en');
      langPt.textContent = STRINGS.pt.lang_pt; langEn.textContent = STRINGS.pt.lang_en; (lang === 'pt' ? langPt : langEn).classList.add('active');

      const searchBtn = document.getElementById('search-btn');
      const queryInput = document.getElementById('query-search');
      const resultDiv = document.getElementById('div-result-games');
      const loadingMessage = document.getElementById('loading-message');

      function extractPriceValue(priceString){ if(!priceString) return Infinity; const clean = priceString.replace(/[^\d,.]/g,'').replace(',', '.'); const p = parseFloat(clean); return isNaN(p) ? Infinity : p; }
      function sortGamesByPrice(games){ return games.sort((a,b)=> extractPriceValue(a.price) - extractPriceValue(b.price)); }

      function createEnebaManualCard(query){
        const enebaUrl = `https://www.eneba.com/br/store/all?enb_campaign=Main%20Search&enb_content=search%20dropdown%20-%20input&enb_medium=input&enb_source=https%3A%2F%2Fwww.eneba.com%2Fstore%2Fall&enb_term=Submit&page=1&regions[]=latam&text=${encodeURIComponent(query)}`;
        const div = document.createElement('div'); div.className='game-card eneba-manual-card';
        div.innerHTML = `
          <a href="${enebaUrl}" target="_blank" class="game-link">
            <div class="game-card-content">
              <div class="game-info">
                <h3 class="game-title">${T.eneba_manual_title}</h3>
                <div class="game-details"><span class="game-price">${T.eneba_manual_cta}</span><span class="game-origin">Eneba</span></div>
                <p class="eneba-warning">${T.eneba_manual_warn}</p>
              </div>
              <div class="manual-search-badge">${T.eneba_manual_badge}</div>
            </div>
          </a>`;
        return div;
      }

      async function fetchHTML(url){
        const tries = [url, `https://cors.isomorphic-git.org/${url}`, `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, `https://corsproxy.io/?${encodeURIComponent(url)}`];
        for(const u of tries){
          try{ const res = await fetch(u, { credentials:'omit' }); if(res.ok){ const text = await res.text(); if(text && text.length>0) return text; } }
          catch(e){ /* tenta pr√≥ximo */ }
        }
        throw new Error('Falha ao obter HTML (CORS/proxy)');
      }

      function parseHTML(text){ return new DOMParser().parseFromString(text,'text/html'); }

      async function fetchInstantGamingResults(query){
        const searchUrl = `https://www.instant-gaming.com/pt/pesquisar/?platform%5B%5D=&type%5B%5D=steam&gametype=games&query=${encodeURIComponent(query)}`;
        const html = await fetchHTML(searchUrl);
        const doc = parseHTML(html);
        const items = Array.from(doc.querySelectorAll('article.item.force-badge'));
        const results = [];
        for(const article of items){
          const titleTag = article.querySelector('span.title');
          const linkTag = article.querySelector('a.cover.video');
          const priceTag = article.querySelector('div.price');
          if(!titleTag || !linkTag) continue;
          const title = (titleTag.textContent||'').trim();
          const href = linkTag.getAttribute('href');
          const fullLink = href && href.startsWith('http') ? href : `https://www.instant-gaming.com${href||''}`;
          let price = priceTag ? (priceTag.textContent||'').trim() : '';
          let linkToUse = fullLink;

          try{
            const prodHtml = await fetchHTML(fullLink);
            const prodDoc = parseHTML(prodHtml);
            let laOption = null;
            const select = prodDoc.querySelector('select.other-products-choices.regions');
            if(select){ laOption = Array.from(select.querySelectorAll('option')).find(opt => /Latin\s*America/i.test(opt.textContent||'')) || null; }
            if(!laOption){
              const nice = prodDoc.querySelector('div.nice.other-products-choices.regions');
              if(nice){ const ul = nice.querySelector('ul.list'); if(ul){ laOption = Array.from(ul.querySelectorAll('li.option')).find(li => /Latin\s*America/i.test(li.textContent||'')) || null; } }
            }
            if(laOption){
              const laPrice = (laOption.getAttribute('data-product-price')||'').trim();
              const laHref = (laOption.getAttribute('data-href')||'').trim();
              if(laPrice) price = laPrice;
              if(laHref) linkToUse = laHref; // removido uso de data-value
            }
          }catch(e){ /* mant√©m pre√ßo/link padr√£o */ }

          if(title && price){ results.push({ title, price, link: linkToUse, origin: 'Instant Gaming' }); }
        }
        return results;
      }

      async function searchGame(query){
        try{
          loadingMessage.classList.remove('hidden');
          resultDiv.innerHTML='';
          const data = await fetchInstantGamingResults(query);
          loadingMessage.classList.add('hidden');
          if(!data || data.length===0){
            resultDiv.innerHTML = `<div class="no-results"><p>${T.no_results_title} "${query}"</p><p>${T.no_results_tip}</p></div>`;
            resultDiv.appendChild(createEnebaManualCard(query));
            return;
          }
          const sorted = sortGamesByPrice(data);
          resultDiv.innerHTML='';
          resultDiv.appendChild(createEnebaManualCard(query));
          sorted.forEach(game=>{
            const el = document.createElement('div'); el.className='game-card';
            el.innerHTML = `
              <a href="${game.link}" target="_blank" class="game-link">
                <div class="game-card-content">
                  <div class="game-info">
                    <h3 class="game-title">${game.title}</h3>
                    <div class="game-details">
                      <span class="game-price ${extractPriceValue(game.price)===0?'free':''}">${game.price}</span>
                      <span class="game-origin">${game.origin}</span>
                    </div>
                  </div>
                </div>
              </a>`;
            resultDiv.appendChild(el);
          });
        }catch(error){
          console.error('Erro na pesquisa: ', error);
          loadingMessage.classList.add('hidden');
          resultDiv.innerHTML = `<div class="error-message"><p>${T.error_unexpected}</p></div>`;
          resultDiv.appendChild(createEnebaManualCard(queryInput.value.trim()));
        }
      }

      searchBtn.addEventListener('click', ()=>{ const q = queryInput.value.trim(); if(q) searchGame(q); });
      queryInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ const q = queryInput.value.trim(); if(q) searchGame(q); } });
    </script>
  </body>
</html>